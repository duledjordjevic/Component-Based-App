{% block head_sadrzaj %}
<style>

.node {
  cursor: pointer;
  color: #DCEDFF;
  
}
.link {
  fill: none;
  stroke: #9ecae1;
  stroke-width: 1.5px;
}

</style>
<script>
    function nodeClick(el){
       console.log("ID: "+el.id);
    }
</script>

<script type="text/javascript" src="https://d3js.org/d3.v7.js"></script>
{% endblock %}
{% block content %}
<svg width="100%" height="100%">

</svg>
<script>

    var nodes={
        // Prodavnice
        {% for node in graph.nodes %}
            "node_{{node.id}}":  {
                name: "node_{{node.id}}",
                data : {
                    {% for key, value in node.data.items() %}
                        "{{ key }}": {{ value|tojson|safe }} {% if not loop.last %},{% endif %}
                    {% endfor %}
                }
            },
        {% endfor %}
    };


    var links=[
        {% for edge in graph.edges %}
            {
                source:"node_{{edge.source.id}}",
                target:"node_{{edge.destination.id}}"
            },
        {% endfor %}
    ];

    var pairedLinks = [];
    var unpairedLinks = [];

    for (var i = 0; i < links.length; i++) {
        var link1 = links[i];

        isFindPair = false;
        for (var j = i + 1; j < links.length; j++) {
            var link2 = links[j];
            
            if (link1.source === link2.target && link1.target === link2.source) {
                pairedLinks.push(link1);
                isFindPair = true;
            }
        }
        if (!isFindPair){
            unpairedLinks.push(link1);
        }
            
    }


    pairedLinks.forEach(function(link) {
        link.source = nodes[link.source];
        link.target = nodes[link.target];
    });
    unpairedLinks.forEach(function(link) {
        link.source = nodes[link.source];
        link.target = nodes[link.target];
    });


    var svg=d3.select('svg');

    const zoom = d3.zoom().on("zoom", zoomed);

    svg = svg.call(zoom).append("g");

    function zoomed(event) {
        const { transform } = event;

        svg.attr("transform", transform.toString());
    }

   
    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(.03).restart();
        d.fx = d.x;
        d.fy = d.y;
    }
    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }
    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(.03);
        d.fx = null;
        d.fy = null;
    }

    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function(d) { return d.name; }))
        .force("charge", d3.forceManyBody().strength(-2000))
        .force("center", d3.forceCenter(1200 / 2, 1200 / 2))
        .nodes(Object.values(nodes))
        .on("tick", tick);


    var arrowhead = svg.append('defs').append('marker')
        .attr('id', 'arrowhead')
        .attr('viewBox', '-0 -5 10 10')
        .attr('refX', 10)
        .attr('refY', 0)
        .attr('orient', 'auto')
        .attr('markerWidth', 8)
        .attr('markerHeight', 8)
        .attr('xoverflow', 'visible')
        .append('path')
        .attr('fill', '#77BFA3')
        .attr('d', 'M 0,-5 L 10 ,0 L 0,5');

    var pairedLink = svg.selectAll('.link')
        .data(links)
        .enter().append('line')
        .attr('class', 'link')
        .attr('marker-end', 'url(#arrowhead)');

    var unpairedLink = svg.selectAll('.link')
        .data(links)
        .enter().append('line')
        .attr('class', 'link');

    var node = svg.selectAll('.node')
        .data(simulation.nodes())
        .enter().append('g')
        .attr('class', 'node')
        .attr('id', function(d) {return d.name; })
        .on('click', function() {
            nodeClick(this);
        })
        .call(d3.drag().on("start", dragstarted)
                        .on("drag", dragged)
                    .on("end", dragended));

    node.each(function(d) {
        slozenPrikaz(d);
    });

    function slozenPrikaz(d) {

        console.log(d)

        var duzina = 150;
        var dataNumberOfKeys = Object.keys(d.data).length;

        var textSize = 10;
        var visina = 100;
        visina += textSize;

        d3.select("g#" + d.name)
            .append('rect')
            .attr('x', 0)
            .attr('y', 0)
            .attr('width', duzina)
            .attr('height', visina)
            .attr('fill', '#77BFA3');

        d3.select("g#" + d.name)
            .append('text')
            .attr('x', duzina / 2)
            .attr('y', 10)
            .attr('text-anchor', 'middle')
            .attr('font-size', textSize)
            .attr('font-family', 'sans-serif')
            .attr('fill', '#ffffff')
            .text(d.name);

        d3.select("g#" + d.name)
            .append('line')
            .attr('x1', 0)
            .attr('y1', textSize)
            .attr('x2', duzina)
            .attr('y2', textSize)
            .attr('stroke', 'white')
            .attr('stroke-width', 2);


        Object.entries(d.data).forEach(function([key, value], index) {
            const maxLength = 27;
            let displayValue = '...';
            if (value != null) {
                displayValue = (key.length + value.length || 0) > maxLength ? value.slice(0, maxLength) + '...' : value;
            } else {
                displayValue = 'None';
            }

            d3.select("g#" + d.name)
                .append('text')
                .attr('x', 0)
                .attr('y', 20 + index * textSize)
                .attr('text-anchor', 'start')
                .attr('font-size', textSize)
                .attr('font-family', 'sans-serif')
                .attr('fill', '#ffffff')
                .text(key + ": " + displayValue);
        });

    }

    function tick() {

        node.attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
        });

        unpairedLink.attr('x1', function(d) { return d.source.x; })
            .attr('y1', function(d) { return d.source.y; })
            .attr('x2', function(d) { return d.target.x; })
            .attr('y2', function(d) { return d.target.y; });

        pairedLink.attr('x1', function(d) { return d.source.x; })
            .attr('y1', function(d) { return d.source.y; })
            .attr('x2', function(d) { return d.target.x; })
            .attr('y2', function(d) { return d.target.y; });
    }


    

</script>
{% endblock %}