{% block head_sadrzaj %}
<style>

.node {
  cursor: pointer;
  color: #DCEDFF;
  
}
.link {
  fill: none;
  stroke: #9ecae1;
  stroke-width: 1.5px;
}

</style>
<script>
    function nodeClick(el){
       console.log("ID: "+el.id);
    }
</script>

<script type="text/javascript" src="https://d3js.org/d3.v3.js"></script>
{% endblock %}
{% block content %}
<svg width="100%" height="100%">

</svg>
<script>
    var svg=d3.select('svg')
    .call(d3.behavior.zoom().on("zoom", function () {

        console.log("okida se dogadjaj")
        svg.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
    }))
    .append("g"); 


   
    function dragstart(d) {
        d3.event.sourceEvent.stopPropagation();
        d3.select(this).classed("fixed", d.fixed = true);
    }
    function dragend(d) {
        d3.event.sourceEvent.stopPropagation();
        d3.select(this).classed("fixed", d.fixed = false);
    }


    var nodes={
        // Prodavnice
        {% for node in graph.nodes %}
            "node_{{node.id}}":  {
                name: "node_{{node.id}}",
                data : {
                    {% for key, value in node.data.items() %}
                        "{{ key }}": {{ value|tojson|safe }} {% if not loop.last %},{% endif %}
                    {% endfor %}
                }
            },
        {% endfor %}
    };


    var links=[
        {% for edge in graph.edges %}
            {
                source:"node_{{edge.source.id}}",
                target:"node_{{edge.destination.id}}"
            },
        {% endfor %}
    ];

    var pairedLinks = [];
    var unpairedLinks = [];

    for (var i = 0; i < links.length; i++) {
        var link1 = links[i];

        isFindPair = false;
        for (var j = i + 1; j < links.length; j++) {
            var link2 = links[j];
            
            if (link1.source === link2.target && link1.target === link2.source) {
                pairedLinks.push(link1);
                isFindPair = true;
            }
        }
        if (!isFindPair){
            unpairedLinks.push(link1);
        }
            
    }


    pairedLinks.forEach(function(link) {
        link.source = nodes[link.source];
        link.target = nodes[link.target];
    });
    unpairedLinks.forEach(function(link) {
        link.source = nodes[link.source];
        link.target = nodes[link.target];
    });


    var force = d3.layout.force() 
        .size([1200, 1200]) 
        .nodes(d3.values(nodes)) 
        .links(links) 
        .on("tick", tick)          
        .linkDistance(700) 
        .charge(-2000) 
        .start(); 

    var drag = force.drag()
        .on("dragstart", dragstart)
        .on("dragend", dragend);


    
    svg.append('defs').append('marker')
        .attr('id', 'arrowhead')
        .attr('viewBox', '-0 -5 10 10')
        .attr('refX', 10)
        .attr('refY', 0)
        .attr('orient', 'auto')
        .attr('markerWidth', 8)
        .attr('markerHeight', 8)
        .attr('xoverflow', 'visible')
        .append('svg:path')
        .attr('fill','#77BFA3')
        .attr('d', 'M 0,-5 L 10 ,0 L 0,5') 
    
    var pairedLink = svg.selectAll('.link')
        .data(links)
        .enter().append('line')
        .attr('class', 'link')
        .attr('marker-end', 'url(#arrowhead)');

    var unpairedLink = svg.selectAll('.link')
        .data(links)
        .enter().append('line')
        .attr('class', 'link');

    var node = svg.selectAll('.node')
        .data(force.nodes()) //add
        .enter().append('g')
        .attr('class', 'node')
        .attr('id', function(d){return d.name;})
        .on('click',function(){
           nodeClick(this);
        });


    d3.selectAll('.node').each(function(d){slozenPrikaz(d);});

    function slozenPrikaz(d){

      var duzina=150;
      var dataNumberOfKeys=Object.keys(d.data).length;

      var textSize=10;
      var visina=100;
      visina+=textSize;

      d3.select("g#"+d.name)
          .append('rect')
          .attr('x',0)
          .attr('y',0)
          .attr('width',duzina)
          .attr('height',visina)
          .attr('fill','#77BFA3');

      d3.select("g#"+d.name)
          .append('text')
          .attr('x',duzina/2)
          .attr('y',10)
          .attr('text-anchor','middle')
          .attr('font-size',textSize)
          .attr('font-family','sans-serif')
          .attr('fill','#ffffff')
          .text(d.name);

      d3.select("g#"+d.name)
          .append('line')
          .attr('x1',0)
          .attr('y1',textSize)
          .attr('x2',duzina)
          .attr('y2',textSize)
          .attr('stroke','white')
          .attr('stroke-width',2);

        
        Object.entries(d.data).forEach(function([key, value], index) {
            const maxLength = 27; 
            let displayValue = '...';
            if(value != null){
                displayValue = (key.length + value.length || 0) > maxLength ? value.slice(0, maxLength) + '...' : value;
            }else{
                displayValue = 'None';
            }
           
            d3.select("g#" + d.name)
                .append('text')
                .attr('x', 0)
                .attr('y', 20 + index * textSize)  
                .attr('text-anchor', 'start')
                .attr('font-size', textSize)
                .attr('font-family', 'sans-serif')
                .attr('fill', '#ffffff')
                .text(key + ": " + displayValue);
        });
        
    }


    function tick(e) {

        node.attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
        }).call(force.drag);

        unpairedLink.attr('x1', function(d) { return d.source.x; })
            .attr('y1', function(d) { return d.source.y; })
            .attr('x2', function(d) { return d.target.x; })
            .attr('y2', function(d) { return d.target.y; });

        pairedLink.attr('x1', function(d) { return d.source.x; })
            .attr('y1', function(d) { return d.source.y; })
            .attr('x2', function(d) { return d.target.x; })
            .attr('y2', function(d) { return d.target.y; });
    }

    

</script>
{% endblock %}